<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>리뷰 섹션</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 0; }
    .review-box {
      max-width: 600px; margin: 3em auto; padding: 2em;
      border-radius: 12px; background: #ffffff; box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .star-rating {
      display: flex; justify-content: center; flex-direction: row-reverse;
      font-size: 2rem; margin-bottom: 1em;
    }
    .star-rating input { display: none; }
    .star-rating label {
      color: #ccc; cursor: pointer; transition: color 0.2s;
    }
    .star-rating input:checked ~ label,
    .star-rating label:hover, .star-rating label:hover ~ label {
      color: #ffca28;
    }
    textarea {
      width: 100%; padding: 1em; font-size: 1em;
      border: 1px solid #ddd; border-radius: 8px;
      resize: vertical; min-height: 100px;
    }
    button {
      margin-top: 1em; width: 100%; padding: 0.8em;
      font-size: 1em; background-color: #4caf50;
      color: white; border: none; border-radius: 8px; cursor: pointer;
    }
    #reviewList { margin-top: 2em; }
    .review-item { padding: 1em; border-bottom: 1px solid #eee; }
  </style>
</head>
<body>
  <div class="review-box">
    <div style="text-align:right;">
      <a href="https://wiki.kkomaweb.com">
        <img src="https://i.ibb.co/fVrVhX81/7606136-removebg-preview.png" alt="홈으로" style="height:40px;" />
      </a>
    </div>
    <h2>리뷰 남기기</h2>
    <div class="star-rating">
      <input type="radio" id="5" name="rating" value="5"/><label for="5">&#9733;</label>
      <input type="radio" id="4" name="rating" value="4"/><label for="4">&#9733;</label>
      <input type="radio" id="3" name="rating" value="3"/><label for="3">&#9733;</label>
      <input type="radio" id="2" name="rating" value="2"/><label for="2">&#9733;</label>
      <input type="radio" id="1" name="rating" value="1"/><label for="1">&#9733;</label>
    </div>
    <textarea id="reviewText" placeholder="리뷰를 입력해주세요..."></textarea>
    <button onclick="submitReview()">리뷰 등록</button>
    <div id="reviewList"></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      // 사용자의 firebaseConfig 주입 필요
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);

    let currentUser = null;

    onAuthStateChanged(auth, async user => {
      if (user) {
        currentUser = user;
        loadReviews();
      } else {
        alert("로그인 후 이용 가능합니다.");
        location.href = "/";
      }
    });

    async function submitReview() {
      const rating = document.querySelector("input[name='rating']:checked")?.value;
      const text = document.getElementById("reviewText").value.trim();
      if (!rating || !text) {
        alert("별점과 리뷰를 모두 입력해주세요.");
        return;
      }

      const res = await fetch('/api/review/add', {
        method: 'POST',
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          uid: currentUser.uid,
          email: currentUser.email,
          rating: parseFloat(rating),
          text
        })
      });

      if (res.ok) {
        alert("리뷰가 등록되었습니다.");
        document.getElementById("reviewText").value = "";
        loadReviews();
      } else {
        alert("등록 실패");
      }
    }

    async function loadReviews() {
      const res = await fetch('/api/review/list');
      const data = await res.json();
      const listEl = document.getElementById("reviewList");
      listEl.innerHTML = "<h3>리뷰 목록</h3>";

      for (const item of data) {
        const div = document.createElement("div");
        div.className = "review-item";
        
        div.innerHTML = `
          <strong>${item.email}</strong><br/>
          ${renderStars(item.rating)}
          <div style='margin-top: 0.5em;'>${item.text}</div>
          <div style='display: flex; gap: 1em; margin-top: 0.5em; align-items: center;'>
            <button class="like-btn" style="padding: 4px 10px; border: none; background: #ffc107; border-radius: 6px; cursor: pointer;" data-id="${item.id}">👍 좋아요 <span>${item.likes || 0}</span></button>
            <button class="reply-toggle-btn" style="padding: 4px 10px; border: none; background: #03a9f4; color: white; border-radius: 6px; cursor: pointer;" data-id="${item.id}">💬 답글</button>
          </div>
          <div class="reply-box" style="display:none; margin-top:0.5em;">
            <textarea rows="2" style="width:100%; padding:0.5em; font-size:0.95em; border:1px solid #ccc; border-radius:6px;" placeholder="답글을 입력하세요..." style="width:100%; padding:0.5em;"></textarea>
            <button class="reply-submit-btn" style="margin-top: 0.4em; padding: 6px 12px; background-color: #4caf50; color: white; border: none; border-radius: 6px; cursor: pointer;" data-id="${item.id}" style="margin-top:0.5em;">답글 등록</button>
            <div class="reply-list" style="margin-top:0.8em; padding-left:0.5em; border-left: 2px solid #eee;" style="margin-top:0.5em;"></div>
          </div>
        `;
    
        listEl.appendChild(div);
      }
    }

    function renderStars(rating) {
      let html = "";
      for (let i = 1; i <= 5; i++) {
        if (rating >= i) {
          html += "★";
        } else if (rating >= i - 0.5) {
          html += "☆";  // Simplified half-star fallback
        } else {
          html += "☆";
        }
      }
      return `<div style='color:#ffca28; font-size:1.4em;'>${html}</div>`;
    }
  
document.getElementById("reviewList").addEventListener("click", async function(e) {
  if (e.target.classList.contains("like-btn")) {
    const id = e.target.dataset.id;
    const btn = e.target;
    const res = await fetch("/api/review/like", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ reviewId: id })
    });
    if (res.ok) {
      const span = btn.querySelector("span");
      span.innerText = parseInt(span.innerText) + 1;
    }
  }

  if (e.target.classList.contains("reply-toggle-btn")) {
    const replyBox = e.target.parentElement.nextElementSibling;
    replyBox.style.display = replyBox.style.display === "none" ? "block" : "none";
    const replyList = replyBox.querySelector(".reply-list");
    replyList.innerHTML = "불러오는 중...";
    const res = await fetch(`/api/review/reply?reviewId=${e.target.dataset.id}`);
    const replies = await res.json();
    replyList.innerHTML = replies.map(r => `<div><strong>${r.email}</strong>: ${r.text}</div>`).join('');
  }

  if (e.target.classList.contains("reply-submit-btn")) {
    const id = e.target.dataset.id;
    const textarea = e.target.previousElementSibling;
    const text = textarea.value.trim();
    if (!text) return alert("답글을 입력하세요.");
    const res = await fetch(`/api/review/reply?reviewId=${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ uid: currentUser.uid, email: currentUser.email, text })
    });
    if (res.ok) {
      textarea.value = "";
      e.target.previousElementSibling.previousElementSibling.click(); // reload replies
    }
  }
});

</script>
</body>
</html>